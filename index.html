<script>
    AOS.init({ duration: 1000, offset: 50, once: true });

    // ... (إبقاء كود الترجمات translations و toggleLanguage كما هو دون تغيير) ...
    // ... تأكد من نسخ دالة updateText الموجودة سابقاً هنا ...

    // دالة تحديث قائمة الملفات (تم التعديل لتدعم ملف واحد فقط)
    function updateFileList() {
        const input = document.getElementById('imageInput');
        const output = document.getElementById('fileList');
        
        if (input.files.length > 0) {
            const file = input.files[0];
            // تحقق سريع من الحجم للمستخدم (2MB)
            if(file.size > 2 * 1024 * 1024) {
                output.style.color = 'red';
                output.innerText = currentLang === 'ar' ? "عذراً، حجم الصورة يجب أن يكون أقل من 2 ميجابايت" : "Error: Image size must be under 2MB";
                input.value = ""; // تفريغ الإدخال
            } else {
                output.style.color = 'var(--accent)';
                output.innerText = currentLang === 'ar' ? `تم اختيار: ${file.name}` : `Selected: ${file.name}`;
            }
        } else {
            output.innerText = '';
        }
    }

    // دالة إشعار الدعاء (كما هي)
    function showDuaNotification() {
        if (document.querySelector('.dua-toast')) return;
        const msg = currentLang === 'ar' 
            ? "اللهم اغفر له وارحمه وبارك في عمله.. (جزاكم الله خيراً)" 
            : "May Allah forgive him and bless his work.. (Jazak Allah Khair)";
        const toast = document.createElement('div');
        toast.className = 'dua-toast';
        toast.innerHTML = `<i class="fas fa-hands-praying"></i> <span>${msg}</span>`;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOutDown 0.5s ease forwards';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    // ============ الدالة المصححة بالكامل ============
    async function sendToTelegram(e) {
        e.preventDefault();
        
        const nameInput = document.getElementById('name');
        const messageInput = document.getElementById('message');
        const imageInput = document.getElementById('imageInput');
        const btn = document.getElementById('submitBtn');
        const status = document.getElementById('statusMessage');

        // التحقق من المدخلات
        const name = nameInput.value || (currentLang === 'ar' ? "فاعل خير" : "User");
        const message = messageInput.value;

        // تعطيل الزر لمنع التكرار
        btn.style.opacity = "0.7"; 
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
        status.style.display = 'none';

        try {
            let photoBase64 = null;
            
            // معالجة الصورة مع التحقق من النوع والحجم
            if (imageInput.files.length > 0) {
                const file = imageInput.files[0];
                const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                
                if (!validTypes.includes(file.type)) {
                    throw new Error(currentLang === 'ar' ? "نوع الملف غير مدعوم. يرجى اختيار صورة." : "Unsupported file type.");
                }
                
                if (file.size > 2 * 1024 * 1024) { // 2MB Limit
                    throw new Error(currentLang === 'ar' ? "حجم الصورة كبير جداً." : "Image is too large (Max 2MB).");
                }

                photoBase64 = await toBase64(file);
            }

            const response = await fetch('/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    message: message,
                    photo: photoBase64 
                })
            });

            // قراءة رد السيرفر
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Server Error');
            }

            // نجاح العملية
            status.style.display = 'block'; 
            status.style.color = '#0d9488'; 
            status.innerText = currentLang === 'ar' ? "✅ تم الإرسال بنجاح! شكراً لتواصلك." : "✅ Sent successfully!";
            
            // تنظيف النموذج
            document.getElementById('telegramForm').reset();
            document.getElementById('fileList').innerText = '';

        } catch (error) {
            console.error("Submission Error:", error);
            status.style.display = 'block'; 
            status.style.color = '#dc2626';
            // عرض رسالة الخطأ للمستخدم
            status.innerText = error.message || (currentLang === 'ar' ? "❌ حدث خطأ، يرجى المحاولة لاحقاً." : "❌ Error sending message.");
        } finally {
            // إعادة تفعيل الزر بشكل سليم
            btn.style.opacity = "1"; 
            btn.disabled = false; 
            btn.innerHTML = currentLang === 'ar' 
                ? '<span id="send-text">إرسال الرسالة</span> <i class="fas fa-paper-plane"></i>' 
                : '<span id="send-text">Send Message</span> <i class="fas fa-paper-plane"></i>';
            
            // إخفاء رسالة النجاح بعد فترة
            if(status.style.color === 'rgb(13, 148, 136)' || status.style.color === '#0d9488') {
                setTimeout(() => { status.style.display = 'none'; }, 5000);
            }
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>
